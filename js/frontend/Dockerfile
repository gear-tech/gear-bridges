FROM node:20-alpine AS node
RUN apk update
RUN apk add xsel
RUN npm install --global serve

FROM node
COPY package.json yarn.lock lerna.json .yarnrc.yml /app/
COPY .yarn /app/.yarn
COPY js/frontend /app/js/frontend
COPY js/common /app/js/common
COPY js/bridge-js /app/js/bridge-js
WORKDIR /app
RUN yarn workspaces focus frontend gear-bridges gear-bridge-common @gear-js/bridge
RUN yarn build:common
RUN yarn build:bridge-js

ARG VITE_VARA_NODE_ADDRESSES \
    VITE_ETH_NODE_ADDRESSES \
    VITE_ETH_CHAIN_IDS \
    VITE_WALLET_CONNECT_PROJECT_ID \
    VITE_INDEXER_ADDRESSES \
    VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESSES \
    VITE_VFT_MANAGER_CONTRACT_ADDRESSES \
    VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESSES \
    VITE_ERC20_MANAGER_CONTRACT_ADDRESSES \
    VITE_TOKEN_PRICE_API_URL \
    VITE_FAUCET_API_URL \
    VITE_TURNSTILE_SITEKEY \
    VITE_VARA_ARCHIVE_NODE_ADDRESSES \
    VITE_ETH_BEACON_NODE_ADDRESSES \
    VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESSES \
    VITE_GTM_ID

ENV VITE_VARA_NODE_ADDRESSES=${VITE_VARA_NODE_ADDRESSES} \
    VITE_ETH_NODE_ADDRESSES=${VITE_ETH_NODE_ADDRESSES} \
    VITE_ETH_CHAIN_IDS=${VITE_ETH_CHAIN_IDS} \
    VITE_WALLET_CONNECT_PROJECT_ID=${VITE_WALLET_CONNECT_PROJECT_ID} \
    VITE_INDEXER_ADDRESSES=${VITE_INDEXER_ADDRESSES} \
    VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESSES=${VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESSES} \
    VITE_VFT_MANAGER_CONTRACT_ADDRESSES=${VITE_VFT_MANAGER_CONTRACT_ADDRESSES} \
    VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESSES=${VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESSES} \
    VITE_ERC20_MANAGER_CONTRACT_ADDRESSES=${VITE_ERC20_MANAGER_CONTRACT_ADDRESSES} \
    VITE_TOKEN_PRICE_API_URL=${VITE_TOKEN_PRICE_API_URL} \
    VITE_FAUCET_API_URL=${VITE_FAUCET_API_URL} \
    VITE_TURNSTILE_SITEKEY=${VITE_TURNSTILE_SITEKEY} \
    VITE_VARA_ARCHIVE_NODE_ADDRESSES=${VITE_VARA_ARCHIVE_NODE_ADDRESSES} \
    VITE_ETH_BEACON_NODE_ADDRESSES=${VITE_ETH_BEACON_NODE_ADDRESSES} \
    VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESSES=${VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESSES} \
    VITE_GTM_ID=${VITE_GTM_ID}


WORKDIR /app/js/frontend
RUN yarn build

CMD ["serve", "-s", "/app/js/frontend/dist"]
