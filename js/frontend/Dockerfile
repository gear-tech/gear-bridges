FROM node:20-alpine AS node
RUN apk update
RUN apk add xsel
RUN npm install --global serve

FROM node
COPY package.json yarn.lock lerna.json .yarnrc.yml /app/
COPY .yarn /app/.yarn
COPY js/frontend /app/js/frontend
COPY js/common /app/js/common
WORKDIR /app
RUN yarn workspaces focus frontend gear-bridges gear-bridge-common
RUN yarn build:common

ARG VITE_VARA_NODE_ADDRESS \
    VITE_ETH_NODE_ADDRESS \
    VITE_ETH_CHAIN_ID \
    VITE_WALLET_CONNECT_PROJECT_ID \
    VITE_INDEXER_ADDRESS \
    VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESS \
    VITE_VFT_MANAGER_CONTRACT_ADDRESS \
    VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESS \
    VITE_ERC20_MANAGER_CONTRACT_ADDRESS \
    VITE_TOKEN_PRICE_API_URL \
    VITE_FAUCET_API_URL \
    VITE_HCAPTCHA_SITEKEY \
    VITE_VARA_ARCHIVE_NODE_ADDRESS \
    VITE_ETH_BEACON_NODE_ADDRESS \
    VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESS \
    VITE_CHECKPOINT_CLIENT_CONTRACT_ADDRESS \
    VITE_HISTORICAL_PROXY_CONTRACT_ADDRESS \
    VITE_GTM_ID

ENV VITE_VARA_NODE_ADDRESS=${VITE_VARA_NODE_ADDRESS} \
    VITE_ETH_NODE_ADDRESS=${VITE_ETH_NODE_ADDRESS} \
    VITE_ETH_CHAIN_ID=${VITE_ETH_CHAIN_ID} \
    VITE_WALLET_CONNECT_PROJECT_ID=${VITE_WALLET_CONNECT_PROJECT_ID} \
    VITE_INDEXER_ADDRESS=${VITE_INDEXER_ADDRESS} \
    VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESS=${VITE_BRIDGING_PAYMENT_CONTRACT_ADDRESS} \
    VITE_VFT_MANAGER_CONTRACT_ADDRESS=${VITE_VFT_MANAGER_CONTRACT_ADDRESS} \
    VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESS=${VITE_ETH_BRIDGING_PAYMENT_CONTRACT_ADDRESS} \
    VITE_ERC20_MANAGER_CONTRACT_ADDRESS=${VITE_ERC20_MANAGER_CONTRACT_ADDRESS} \
    VITE_TOKEN_PRICE_API_URL=${VITE_TOKEN_PRICE_API_URL} \
    VITE_FAUCET_API_URL=${VITE_FAUCET_API_URL} \
    VITE_HCAPTCHA_SITEKEY=${VITE_HCAPTCHA_SITEKEY} \
    VITE_VARA_ARCHIVE_NODE_ADDRESS=${VITE_VARA_ARCHIVE_NODE_ADDRESS} \
    VITE_ETH_BEACON_NODE_ADDRESS=${VITE_ETH_BEACON_NODE_ADDRESS} \
    VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESS=${VITE_ETH_MESSAGE_QUEUE_CONTRACT_ADDRESS} \
    VITE_CHECKPOINT_CLIENT_CONTRACT_ADDRESS=${VITE_CHECKPOINT_CLIENT_CONTRACT_ADDRESS} \
    VITE_HISTORICAL_PROXY_CONTRACT_ADDRESS=${VITE_HISTORICAL_PROXY_CONTRACT_ADDRESS} \
    VITE_GTM_ID=${VITE_GTM_ID}


WORKDIR /app/js/frontend
RUN yarn build

CMD ["serve", "-s", "/app/js/frontend/dist"]
